name: Mirror B to A (With PR Sync)

on:
  schedule:
    - cron: '*/5 * * * *'  # 每 5 分钟同步一次
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # 工作流自身只需读权限
      pull-requests: write  # 自动创建 PR 需要写权限

    steps:
      - name: Show context
        run: |
          echo "Run at: $(date -u) UTC"
          git --version

      - name: Mirror B to A branches & tags
        env:
          SRC: https://github.com/wangchunsheng-ops/testgithub.git
          DST: https://x-access-token:${{ secrets.PUSH_TOKEN }}@github.com/wangchunsheng-ops/mirror.git
        run: |
          set -e
          echo "🚀 Cloning source repository B..."
          git clone --mirror "$SRC" mirror.git
          cd mirror.git

          # 清理 refs/pull/* 和 refs/notes/*，避免 push 错误
          git for-each-ref --format='delete %(refname)' refs/pull | git update-ref --stdin
          git for-each-ref --format='delete %(refname)' refs/notes | git update-ref --stdin

          echo "📤 Pushing branches and tags to A..."
          git push --force --prune "$DST" \
            'refs/heads/*:refs/heads/*' \
            'refs/tags/*:refs/tags/*'

      - name: Create PRs in A for new branches
        env:
          GITHUB_TOKEN: ${{ secrets.PUSH_TOKEN }}
          REPO_OWNER: wangchunsheng-ops
          REPO_NAME: mirror
          SRC_REPO: wangchunsheng-ops/testgithub
        run: |
          #!/bin/bash
          set -e

          echo "📌 Fetching B repo branches..."
          BRANCHES=$(curl -s -H "Accept: application/vnd.github+json" https://api.github.com/repos/$SRC_REPO/branches | jq -r '.[].name')

          for BR in $BRANCHES; do
            echo "🔹 Checking branch $BR in A..."
            # 查询 A 是否已有同名 PR
            PR_EXISTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/pulls?state=open&head=$REPO_OWNER:$BR" | jq 'length')

            if [ "$PR_EXISTS" -eq 0 ]; then
              echo "➡ Creating PR for branch $BR in A..."
              curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
                   -H "Accept: application/vnd.github+json" \
                   https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/pulls \
                   -d "{\"title\":\"Mirror branch $BR from B\",\"head\":\"$BR\",\"base\":\"main\",\"body\":\"Auto-synced from $SRC_REPO\"}"
            else
              echo "✅ PR already exists for branch $BR, skipping."
            fi
          done
