name: Mirror from B

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆGitHub Actions çš„æœ€å°å»ºè®®é—´éš”ï¼‰
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # å·¥ä½œæµè‡ªèº«åªéœ€è¯»ï¼›çœŸæ­£çš„æ¨é€ç”¨ä½ çš„ PUSH_TOKEN å®Œæˆ

    steps:
      - name: Show context (debug)
        run: |
          echo "Run at: $(date -u) UTC"
          git --version

      - name: Mirror from B to A (Safe & Clean)
        env:
          SRC: https://github.com/wangchunsheng-ops/testgithub.git
          DST: https://x-access-token:${{ secrets.PUSH_TOKEN }}@github.com/wangchunsheng-ops/mirror.git
        run: |
          set -e
          echo "ğŸš€ Cloning mirror from B..."
          git clone --mirror "$SRC" mirror.git
          cd mirror.git

          # ğŸ”¥ STEP 1: åˆ é™¤ GitHub è‡ªåŠ¨ç”Ÿæˆçš„ refs/pull/*ï¼Œé¿å… push è¢«æ‹’
          echo "ğŸ§¹ Removing refs/pull/* to avoid 'deny updating a hidden ref'..."
          git for-each-ref --format='delete %(refname)' refs/pull | git update-ref --stdin

          # ğŸ”¥ STEP 2: åˆ é™¤ refs/notes/*ï¼ˆå¦‚ PR metadataï¼‰ï¼Œé¿å…ä¸å¿…è¦çš„åŒæ­¥
          echo "ğŸ§¹ Removing refs/notes/*..."
          git for-each-ref --format='delete %(refname)' refs/notes | git update-ref --stdin

          # âœ… STEP 3: åªæ¨é€ heads å’Œ tagsï¼Œä¸ä½¿ç”¨ --mirrorï¼ˆä¿æŠ¤ .github ç›®å½•ï¼‰
          echo "ğŸ“¤ Pushing branches and tags to A..."
          git push --force --prune "$DST" \
            'refs/heads/*:refs/heads/*' \
            'refs/tags/*:refs/tags/*'

          echo "âœ… Sync completed successfully. Your CI files are preserved!"
